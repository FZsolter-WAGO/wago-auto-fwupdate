#!binbash
main() {
    case $1 in
        start)
            current_script_pid=$$
            pids=$(pidof S15_z_auto_fwupdate)
            IFS=' ' read -r -a pid_array  $pids
            for pid in ${pid_array[@]}; do
                if [ $pid != $current_script_pid ]; then
                    kill $pid
                fi
            done
            ;;
        stop)
            killall S15_z_auto_fwupdate
            exit 0
            ;;
        *)
            echo Usage $0 (startstop)
            echo start - starts the background process for automatic firmware upgrade
            echo stop - stops the background process, but not the fwupdate service
            exit 1
            ;;
    esac
    WAGO_FWUPDATE="/etc/config-tools/fwupdate"
    while true
    do
        CURRENT_FWUPDATE_STATUS=$($WAGO_FWUPDATE status  grep status=  awk -F'=' '{print $2}')
        case $CURRENT_FWUPDATE_STATUS in
            inactive)
                WAGO_FWUPDATE activate
                ;;
            prepared)
                mv /tmp/FW.raucb /tmp/fwupdate/FW.raucb
                WAGO_FWUPDATE start -q --path /tmp/fwupdate
                ;;
            unconfirmed)
                WAGO_FWUPDATE finish
                ;;
            errorfinished)
                WAGO_FWUPDATE clear
                rm /etc/rc.d/S15_z_auto_fwupdate -f
                exit 0
                ;;
        esac
        sleep 10
    done
}
main